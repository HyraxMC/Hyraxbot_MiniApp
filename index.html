<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HyraxBot Mini App</title>
  <style>
    :root {
      --bg: #0b1220; --text: #f8fafc; --muted: #94a3b8; --accent: #00c2ff;
      --glass: rgba(255, 255, 255, 0.10); --border: rgba(255, 255, 255, 0.18);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      color: var(--text); background: var(--bg);
      min-height: 100vh; display: grid; grid-template-rows: auto 1fr auto;
    }
    header, nav, .card {
      background: var(--glass); border: 1px solid var(--border); backdrop-filter: blur(12px);
      border-radius: 16px; box-shadow: 0 10px 28px rgba(0,0,0,0.28);
    }
    header { margin: 12px; padding: 12px 14px; display: flex; gap: 12px; align-items: center; }
    header .title { font-weight: 800; }
    header .subtitle { font-size: 12px; color: var(--muted); }
    main { padding: 12px; display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 560px) { main { grid-template-columns: 1fr 1fr; } }
    .card { padding: 14px; }
    .card h3 { margin: 0 0 8px; font-size: 15px; font-weight: 800; }
    .card p { margin: 0 0 12px; font-size: 13px; color: var(--muted); }
    .btn {
      appearance: none; background: linear-gradient(135deg, var(--accent), #6be6ff);
      color: #02131d; border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 800;
      cursor: pointer; box-shadow: 0 6px 20px rgba(0, 194, 255, 0.35);
    }
    nav { margin: 12px; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .tab { padding: 10px 12px; border-radius: 12px; text-align: center; font-weight: 700; cursor: pointer; }
    .tab.active { background: rgba(255,255,255,0.20); }
    .banner {
      margin: 0 12px; padding: 10px 12px; border-radius: 12px; background: #3b0b0b; color: #ffdddd;
      border: 1px solid #6d2020; display: none;
    }
    .meta { font-size: 12px; color: var(--muted); margin-top: 8px; word-break: break-all; }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">HyraxBot Mini App</div>
      <div class="subtitle">Ø§Ø±ØªØ¨Ø§Ø· Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§ Ø±Ø¨Ø§Øª Ùˆ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ ÙÙˆØ±ÛŒ</div>
    </div>
  </header>

  <div id="banner" class="banner">âŒ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø®Ø§Ø±Ø¬ Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§Ø² Ø´Ø¯Ù‡ Ø§Ø³Øª ÛŒØ§ initData Ø®Ø§Ù„ÛŒ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Mini App Ø¯Ø§Ø®Ù„ Ú†Øª Ø®ØµÙˆØµÛŒ Ø±Ø¨Ø§Øª ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.</div>

  <main id="content"></main>

  <nav>
    <div class="tab active" data-section="tests">ğŸ§ª ØªØ³Øªâ€ŒÙ‡Ø§</div>
    <div class="tab" data-section="tools">ğŸ›  Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</div>
    <div class="tab" data-section="general">ğŸ“‚ Ø¹Ù…ÙˆÙ…ÛŒ</div>
  </nav>

  <script>
    function getTG() {
      try {
        return window?.Telegram?.WebApp || null;
      } catch (_) { return null; }
    }
    function insideTelegram(tg) {
      return !!(tg && typeof tg.initData === "string" && tg.initData.length > 0);
    }
    function renderSection(name) {
      const c = document.getElementById("content");
      c.innerHTML = "";

      // Meta card: shows initData length and platform hints
      const meta = document.createElement("div");
      meta.className = "card";
      meta.innerHTML = `
        <h3>ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„</h3>
        <p>Ø·ÙˆÙ„ initData Ùˆ Ø§Ù…Ú©Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒØ¯.</p>
        <div class="meta" id="metaInfo"></div>
      `;
      c.appendChild(meta);

      // Test card
      const test = document.createElement("div");
      test.className = "card";
      test.innerHTML = `
        <h3>ğŸ” ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡</h3>
        <p>Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø±ØªØ¨Ø§Ø· Mini App Ø¨Ø§ Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…ØŒ Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯.</p>
        <button id="btnHello" class="btn">Ø§Ø±Ø³Ø§Ù„ hello</button>
      `;
      c.appendChild(test);

      // Custom payload card
      const custom = document.createElement("div");
      custom.className = "card";
      custom.innerHTML = `
        <h3>ğŸ“¦ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ§Ø±Ø´ÛŒ</h3>
        <p>Ù‡Ø± Ù…ØªÙ†ÛŒ Ø±Ø§ Ø¨ÙØ±Ø³ØªØ› Ø±Ø¨Ø§Øª Ù‡Ù…Ø§Ù† Ø±Ø§ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>
        <input id="inpCmd" placeholder="Ù…Ø«Ù„Ø§Ù‹ /clock ÛŒØ§ Ù‡Ø± Ù…ØªÙ†" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;margin-bottom:8px;">
        <button id="btnSend" class="btn">Ø§Ø±Ø³Ø§Ù„</button>
      `;
      c.appendChild(custom);

      // Section samples
      const samples = {
        tools: [{t:"Ø´Ù†Ø§Ø³Ù‡ Ù…Ù†", d:"/myid"}, {t:"ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø¨Ù‡ ÙˆÛŒØ³", d:"/txt2voc"}],
        general: [{t:"Ø³Ø§Ø¹Øª Ùˆ ØªØ§Ø±ÛŒØ®", d:"/clock"}, {t:"Ø±Ø§Ù‡Ù†Ù…Ø§", d:"/help"}],
        tests: [{t:"Ø³Ù†Ú¯â€ŒÚ©Ø§ØºØ°â€ŒÙ‚ÛŒÚ†ÛŒ", d:"/rps"}, {t:"Fast Button", d:"/fast_button"}],
      };
      (samples[name] || []).forEach(s => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<h3>${s.t}</h3><p>Ø§Ø±Ø³Ø§Ù„: ${s.d}</p><button class="btn">Ø§Ø¬Ø±Ø§</button>`;
        card.querySelector(".btn").onclick = () => sendPayload({type:"command", payload:{command:s.d}});
        c.appendChild(card);
      });

      wire();
    }

    let tg = null;
    function updateMeta() {
      const info = document.getElementById("metaInfo");
      if (!info) return;
      const len = tg?.initData?.length || 0;
      info.textContent = `initData length: ${len} | platform: ${tg?.platform || "unknown"} | colorScheme: ${tg?.colorScheme || "n/a"}`;
    }

    function sendPayload(obj) {
      try {
        tg = getTG();
        if (!insideTelegram(tg) || !tg?.sendData) {
          alert("âŒ WebApp API Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª ÛŒØ§ initData Ø®Ø§Ù„ÛŒ Ø§Ø³Øª. Ø§Ø² Ø¯Ø§Ø®Ù„ Ú†Øª Ø®ØµÙˆØµÛŒ Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Mini App ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.");
          return;
        }
        const envelope = JSON.stringify({
          ...obj,
          ts: Date.now(),
          initData: tg.initData || ""
        });
        tg.sendData(envelope);
        console.log("[MiniApp] sent:", envelope);
        alert("âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯");
      } catch (e) {
        console.error("[MiniApp] send failed:", e);
        alert("âŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯");
      }
    }

    function wire() {
      document.getElementById("btnHello").onclick = () => sendPayload({type:"hello", payload:"hello from miniapp"});
      document.getElementById("btnSend").onclick = () => {
        const v = document.getElementById("inpCmd").value.trim();
        if (!v) return alert("Ù…ØªÙ† ÛŒØ§ Ø¯Ø³ØªÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
        sendPayload({type:"custom", payload:{text:v}});
      };
      updateMeta();
    }

    document.addEventListener("DOMContentLoaded", () => {
      tg = getTG();
      try { tg?.ready?.(); tg?.expand?.(); } catch(e) { console.warn("tg.ready/expand error:", e); }

      const banner = document.getElementById("banner");
      banner.style.display = insideTelegram(tg) ? "none" : "block";

      // tabs
      document.querySelectorAll(".tab").forEach(el => {
        el.onclick = () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          el.classList.add("active");
          renderSection(el.dataset.section);
        };
      });

      renderSection("tests");
    });
  </script>
</body>
</html>
